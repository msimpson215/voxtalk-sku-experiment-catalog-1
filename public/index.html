<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VoxTalk Grocery Assistant (Conversational Voice Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <p class="demo-label">Grocery Assistant (Conversational Voice Demo)</p>
    <h1>Talk to VoxTalk</h1>
    <button id="pttBtn" aria-pressed="false">Start Talking</button>
    <div class="hint">Click <b>Start Talking</b> and just talk!<br>
      Say: "Add 3 bananas", "Add salmon with skin", "Show cart", "Any specials?", "Add ribeye steak", "Add milk", etc.
    </div>
    <div id="answer"><div class="muted">Conversation will appear here.</div></div>
    <audio id="remote" autoplay playsinline></audio>
    <div id="cart-summary"></div>
  </div>

  <script>
    const pttBtn   = document.getElementById('pttBtn');
    const answerEl = document.getElementById('answer');
    const cartSummary = document.getElementById('cart-summary');

    // --- SKU CATALOG ---
    const skuCatalog = {
      "bananas": { sku: "SKU10001", name: "Bananas" },
      "milk": { sku: "SKU10002", name: "Milk" },
      "pineapple": { sku: "SKU10003", name: "Pineapple" },
      "lettuce": { sku: "SKU10004", name: "Lettuce" },
      "salmon with skin": { sku: "SKU10005", name: "Salmon (with skin)" },
      "salmon no skin": { sku: "SKU10006", name: "Salmon (no skin)" },
      "ketchup": { sku: "SKU10007", name: "Ketchup" },
      "beer": { sku: "SKU10008", name: "Beer" },
      "steak": { sku: "SKU10009", name: "Steak" },
      "ribeye steak": { sku: "SKU10010", name: "Ribeye Steak" },
      "special steak": { sku: "SKU10011", name: "Special Steak" },
      "eggs": { sku: "SKU10012", name: "Eggs" },
      "apple": { sku: "SKU10013", name: "Apple" },
      "cucumber": { sku: "SKU10014", name: "Cucumber" },
      "orange juice": { sku: "SKU10015", name: "Orange Juice" },
      "cheese": { sku: "SKU10016", name: "Cheese" },
      "butter": { sku: "SKU10017", name: "Butter" },
      "tomatoes": { sku: "SKU10018", name: "Tomatoes" },
      "chicken breast": { sku: "SKU10019", name: "Chicken Breast" },
      "potatoes": { sku: "SKU10020", name: "Potatoes" }
    };

    // --- CART LOGIC ---
    let cart = [];

    function addToCart(item, qty=1) {
      let entry = cart.find(e => e.sku === item.sku);
      if (!entry) {
        cart.push({ sku: item.sku, name: item.name, qty });
      } else {
        entry.qty += qty;
      }
      showCart();
    }

    function showCart() {
      if (!cart.length) {
        cartSummary.innerHTML = "<b>Your cart is empty.</b>";
        return;
      }
      cartSummary.innerHTML = "<b>Your cart:</b><ul>" +
        cart.map(e => `<li>${e.name} (${e.sku}) x${e.qty}</li>`).join("") +
        "</ul>";
    }

    // --- CHAT DISPLAY ---
    function appendLine(role, text) {
      if (answerEl.querySelector('.muted')) answerEl.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'line';
      div.innerHTML = `<span class="${role}">${role === 'me' ? 'You:' : 'AI:'}</span>
                       <span class="text"> ${text}</span>`;
      answerEl.appendChild(div);
      answerEl.scrollTop = answerEl.scrollHeight;
    }

    function setSpeaking(on) { 
      pttBtn.classList.toggle('speaking', on); 
    }

    function updateButton(talking) {
      pttBtn.textContent = talking ? "Stop Talking" : "Start Talking";
      pttBtn.setAttribute("aria-pressed", talking ? "true" : "false");
    }

    // --- IMPROVED "AI" PARSER FOR VOICE ---
    function processUtterance(utterance) {
      // Map number words to digits
      const numberWords = {
        "zero": 0, "one": 1, "two": 2, "three": 3, "four": 4, "five": 5,
        "six": 6, "seven": 7, "eight": 8, "nine": 9, "ten": 10,
        "eleven": 11, "twelve": 12, "thirteen": 13, "fourteen": 14, "fifteen": 15,
        "sixteen": 16, "seventeen": 17, "eighteen": 18, "nineteen": 19, "twenty": 20
      };

      let utter = utterance.toLowerCase().replace(/-/g, ' ');

      // Try to find a digit in the utterance
      let qty = 1;
      let qtyMatch = utter.match(/\b(\d+)\b/);
      if (qtyMatch) {
        qty = parseInt(qtyMatch[1]);
        utter = utter.replace(qtyMatch[0], '').trim();
      } else {
        // Try to find a number word
        for (const [word, num] of Object.entries(numberWords)) {
          const regex = new RegExp("\\b" + word + "\\b");
          if (regex.test(utter)) {
            qty = num;
            utter = utter.replace(regex, '').trim();
            break;
          }
        }
      }

      // Try to find item name, allow "ribeye" to match "ribeye steak"
      let matchedItem = null;
      for (const key of Object.keys(skuCatalog)) {
        if (utter.includes(key)) {
          matchedItem = skuCatalog[key];
          break;
        }
        // Fuzzy match for "ribeye" => "ribeye steak"
        if (key === "ribeye steak" && utter.includes("ribeye")) {
          matchedItem = skuCatalog[key];
          break;
        }
      }

      let aiReply = "";
      if (matchedItem) {
        aiReply = `Added ${matchedItem.name} (${matchedItem.sku}) x${qty} to your cart.`;
        appendLine("ai", aiReply);
        addToCart(matchedItem, qty);
        speak(aiReply);
        return;
      }

      // Cart summary
      if (/cart|show cart|what's in my cart/.test(utter)) {
        aiReply = "Here is your current cart.";
        appendLine("ai", aiReply);
        showCart();
        speak(aiReply);
        return;
      }
      // Specials
      if (/special|deal/.test(utter)) {
        aiReply = "Today's special: Ribeye Steak (SKU10010) - 20% off!";
        appendLine("ai", aiReply);
        speak(aiReply);
        return;
      }

      aiReply = "Sorry, I didn't understand. Try: 'Add 5 bananas' or 'Put milk in my cart'.";
      appendLine("ai", aiReply);
      speak(aiReply);
    }

    // --- SPEECH SYNTHESIS (AI talks back) ---
    function speak(text) {
      if ('speechSynthesis' in window) {
        const utter = new window.SpeechSynthesisUtterance(text);
        utter.rate = 1.1;
        utter.pitch = 1.1;
        window.speechSynthesis.cancel(); // Stop any current speech
        window.speechSynthesis.speak(utter);
      }
    }

    // --- CONTINUOUS VOICE CONVERSATION ---
    let recognition;
    let recognizing = false;
    let keepListening = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.continuous = false; // Single utterance, but we restart automatically
      recognition.interimResults = false;

      recognition.onstart = function() {
        setSpeaking(true);
        updateButton(true);
        appendLine("me", "(Listening...)");
      };
      recognition.onend = function() {
        setSpeaking(false);
        updateButton(false);
        appendLine("me", "(Stopped)");
        recognizing = false;
        // If user wants continuous, restart listening
        if (keepListening) {
          setTimeout(() => { recognition.start(); recognizing = true; }, 500);
        }
      };
      recognition.onresult = function(event) {
        if (event.results.length) {
          const transcript = event.results[0][0].transcript;
          appendLine("me", transcript);
          processUtterance(transcript);
        }
      };

      pttBtn.onclick = function() {
        if (recognizing || keepListening) {
          keepListening = false;
          recognition.stop();
          recognizing = false;
          updateButton(false);
        } else {
          keepListening = true;
          recognition.start();
          recognizing = true;
          updateButton(true);
        }
      };
    } else {
      pttBtn.disabled = true;
      pttBtn.textContent = "Voice not supported";
      appendLine("ai", "Sorry, your browser does not support speech recognition.");
    }

    showCart();
  </script>
</body>
</html>
