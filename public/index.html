<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VoxTalk Grocery Assistant - Real AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <p class="demo-label">Grocery Assistant (Powered by GPT-4o)</p>
    <h1>Talk to VoxTalk</h1>
    <button id="pttBtn" aria-pressed="false">Start Talking</button>
    <input id="typedInput" type="text" placeholder="Or type a message..." style="width:100%;margin-top:1em;padding:0.5em;font-size:1em;border-radius:6px;border:1px solid #ccc">
    <div id="answer"><div class="muted">Conversation will appear here.</div></div>
  </div>
  <script>
    const pttBtn   = document.getElementById('pttBtn');
    const answerEl = document.getElementById('answer');
    const typedInput = document.getElementById('typedInput');

    function appendLine(role, text) {
      if (answerEl.querySelector('.muted')) answerEl.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'line';
      div.innerHTML = `<span class="${role}">${role === 'me' ? 'You:' : 'AI:'}</span>
                       <span class="text"> ${text}</span>`;
      answerEl.appendChild(div);
      answerEl.scrollTop = answerEl.scrollHeight;
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        let voices = window.speechSynthesis.getVoices();
        let preferred = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang === 'en-US' && v.gender === 'female') || voices.find(v => v.lang.startsWith('en'));
        let utter = new window.SpeechSynthesisUtterance(text);
        if (preferred) utter.voice = preferred;
        utter.rate = 1.07; utter.pitch = 1.08;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      }
    }

    async function sendToAI(text) {
      appendLine("me", text);
      try {
        const res = await fetch("http://localhost:3001/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        appendLine("ai", data.reply);
        speak(data.reply);
      } catch (err) {
        appendLine("ai", "Error talking to AI: " + err.message);
      }
    }

    // Voice input logic
    let recognition; let recognizing = false; let keepListening = false;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();

